<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="https://console.filebase.com/favicon.ico"><title>Source: objectManager.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="fallback-dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">Filebase SDK</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BucketManager.html">BucketManager</a></div><div class="sidebar-section-children"><a href="GatewayManager.html">GatewayManager</a></div><div class="sidebar-section-children"><a href="NameManager.html">NameManager</a></div><div class="sidebar-section-children"><a href="ObjectManager.html">ObjectManager</a></div><div class="sidebar-section-children"><a href="PinManager.html">PinManager</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-quickstart-bucket.html">Buckets</a></div><div class="sidebar-section-children"><a href="tutorial-quickstart-gateway.html">Gateways</a></div><div class="sidebar-section-children"><a href="tutorial-quickstart-name.html">Names</a></div><div class="sidebar-section-children"><a href="tutorial-quickstart-object.html">Objects</a></div><div class="sidebar-section-children"><a href="tutorial-quickstart-pin.html">Pins</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#bucket">bucket</a></div><div class="sidebar-section-children"><a href="global.html#gateway">gateway</a></div><div class="sidebar-section-children"><a href="global.html#gatewayOptions">gatewayOptions</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#nameOptions">nameOptions</a></div><div class="sidebar-section-children"><a href="global.html#objectManagerOptions">objectManagerOptions</a></div><div class="sidebar-section-children"><a href="global.html#objectDownloadOptions">objectDownloadOptions</a></div><div class="sidebar-section-children"><a href="global.html#objectOptions">objectOptions</a></div><div class="sidebar-section-children"><a href="global.html#objectHeadResult">objectHeadResult</a></div><div class="sidebar-section-children"><a href="global.html#listObjectsResult">listObjectsResult</a></div><div class="sidebar-section-children"><a href="global.html#listObjectOptions">listObjectOptions</a></div><div class="sidebar-section-children"><a href="global.html#copyObjectOptions">copyObjectOptions</a></div><div class="sidebar-section-children"><a href="global.html#pinManagerOptions">pinManagerOptions</a></div><div class="sidebar-section-children"><a href="global.html#pinDownloadOptions">pinDownloadOptions</a></div><div class="sidebar-section-children"><a href="global.html#pinStatus">pinStatus</a></div><div class="sidebar-section-children"><a href="global.html#pinOptions">pinOptions</a></div><div class="sidebar-section-children"><a href="global.html#listPinOptions">listPinOptions</a></div><div class="sidebar-section-children"><a href="global.html#listPinResults">listPinResults</a></div><div class="sidebar-section-children"><a href="global.html#replacePinOptions">replacePinOptions</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="navbar-item"><a id="" href="https://github.com/filebase/filebase-sdk" target="_blank">Github</a></div><div class="navbar-item"><a id="" href="https://www.npmjs.com/package/@filebase/sdk" target="_blank">npm</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">objectManager.js</h1></header><article><pre class="prettyprint source lang-js"><code>// Environment Imports
import logger from "./logger.js";
// S3 Imports
import {
  CopyObjectCommand,
  DeleteObjectCommand,
  GetObjectCommand,
  HeadObjectCommand,
  ListObjectsV2Command,
  S3Client,
} from "@aws-sdk/client-s3";
import { Upload } from "@aws-sdk/lib-storage";
// Helia Imports
import { CarWriter } from "@ipld/car";
import { car } from "@helia/car";
import { mfs } from "@helia/mfs";
import { unixfs } from "@helia/unixfs";
import { MemoryBlockstore } from "blockstore-core";
import { MemoryDatastore } from "datastore-core";
// Utility Imports
import { v4 as uuidv4 } from "uuid";
import { downloadFromGateway } from "./helpers.js";
import PQueue from "p-queue";

/** Interacts with an S3 client to perform various operations on objects in a bucket. */
class ObjectManager {
  #DEFAULT_ENDPOINT = "https://s3.filebase.com";
  #DEFAULT_REGION = "us-east-1";
  #DEFAULT_MAX_CONCURRENT_UPLOADS = 4;

  #client;
  #credentials;
  #defaultBucket;
  #gatewayConfiguration;
  #maxConcurrentUploads;

  /**
   * @typedef {Object} objectManagerOptions Optional settings for the constructor.
   * @property {string} [bucket] Default bucket to use.
   * @property {objectDownloadOptions} [gateway] Default gateway to use.
   * @property {number} [maxConcurrentUploads] The maximum number of concurrent uploads.
   */

  /**
   * @typedef {Object} objectDownloadOptions Optional settings for downloading objects
   * @property {string} endpoint Default gateway to use.
   * @property {string} [token] Token for the default gateway.
   * @property {number} [timeout=60000] Timeout for the default gateway
   */

  /**
   * @summary Creates a new instance of the constructor.
   * @param {string} clientKey - The access key ID for authentication.
   * @param {string} clientSecret - The secret access key for authentication.
   * @param {objectManagerOptions} options - Optional settings for the constructor.
   * @tutorial quickstart-object
   * @example
   * import { ObjectManager } from "@filebase/sdk";
   * const objectManager = new ObjectManager("KEY_FROM_DASHBOARD", "SECRET_FROM_DASHBOARD", {
   *   bucket: "my-default-bucket",
   *   maxConcurrentUploads: 4,
   *   gateway: {
   *     endpoint: "https://my-default-gateway.mydomain.com
   *     token: SUPER_SECRET_GATEWAY_TOKEN
   *   }
   * });
   */
  constructor(clientKey, clientSecret, options) {
    const clientEndpoint =
        process.env.NODE_ENV === "test"
          ? process.env.TEST_S3_ENDPOINT || this.#DEFAULT_ENDPOINT
          : this.#DEFAULT_ENDPOINT,
      clientConfiguration = {
        credentials: {
          accessKeyId: clientKey,
          secretAccessKey: clientSecret,
        },
        endpoint: clientEndpoint,
        region: this.#DEFAULT_REGION,
        forcePathStyle: true,
      };
    this.#defaultBucket = options?.bucket;
    this.#maxConcurrentUploads =
      options?.maxConcurrentUploads || this.#DEFAULT_MAX_CONCURRENT_UPLOADS;
    this.#credentials = {
      key: clientKey,
      secret: clientSecret,
    };
    this.#client = new S3Client(clientConfiguration);

    this.#gatewayConfiguration = {
      endpoint: options?.gateway?.endpoint,
      token: options?.gateway?.token,
      timeout: options?.gateway?.timeout,
    };
  }

  /**
   * @typedef {Object} objectOptions
   * @property {string} [bucket] - The bucket to pin the IPFS CID into.
   */

  /**
   * @typedef {Object} objectHeadResult
   * @property {string} cid The CID of the uploaded object
   * @property {function} download Convenience function to download the object via S3 or the selected gateway
   * @property {array&lt;Object>} [entries] If a directory then returns an array of the containing objects
   * @property {string} entries.cid The CID of the uploaded object
   * @property {string} entries.path The path of the object
   */

  /**
   * If the source parameter is an array of objects, it will pack multiple files into a CAR file for upload.
   * The method returns a Promise that resolves to an object containing the CID (Content Identifier) of the uploaded file
   * and an optional entries object when uploading a CAR file.
   *
   * @summary Uploads a file or a CAR file to the specified bucket.
   * @param {string} key - The key or path of the file in the bucket.
   * @param {Buffer|ReadableStream|Array&lt;Object>} source - The content of the object to be uploaded.
   *    If an array of files is provided, each file should have a 'path' property specifying the path of the file
   *    and a 'content' property specifying the content of the file.  The SDK will then construct a CAR file locally
   *    and use that as the content of the object to be uploaded.
   * @param {Object} [metadata] Optional metadata for pin object
   * @param {objectOptions} [options] - The options for uploading the object.
   * @returns {Promise&lt;objectHeadResult>}
   * @example
   * // Upload Object
   * await objectManager.upload("my-object", Buffer.from("Hello World!"));
   * // Upload Object with Metadata
   * await objectManager.upload("my-custom-object", Buffer.from("Hello Big World!"), {
   *   "application": "my-filebase-app"
   * });
   * // Upload Directory
   * await objectManager.upload("my-first-directory", [
   *  {
   *   path: "/testObjects/1.txt",  // Virtual Path to store contents at within IPFS Folder/Directory
   *   content: Buffer.from("upload test object", "utf-8"),
   *  },
   *  {
   *   path: "/testObjects/deep/1.txt",
   *   content: Buffer.from("upload deep test object", "utf-8"),
   *  },
   *  {
   *   path: "/topLevel.txt",
   *   content: Buffer.from("upload top level test object", "utf-8"),
   *  },
   * ]);
   */
  async upload(key, source, metadata, options) {
    // Generate Upload UUID
    const uploadUUID = uuidv4();
    const uploadLogger = logger.child({ uploadUUID });

    // Setup Upload Options
    const bucket = options?.bucket || this.#defaultBucket,
      uploadOptions = {
        client: this.#client,
        params: {
          Bucket: bucket,
          Key: key,
          Body: source,
          Metadata: metadata || {},
        },
        queueSize: this.#maxConcurrentUploads,
        partSize: 26843546, //25.6Mb || 250Gb Max File Size
      };

    // Pack Multiple Files into CAR file for upload
    let parsedEntries = {};
    if (Array.isArray(source)) {
      // Mark Upload as a CAR file import
      uploadOptions.params.Metadata = {
        ...uploadOptions.params.Metadata,
        import: "car",
      };
      source.sort((a, b) => {
        return countSlashes(b.path) - countSlashes(a.path);
      });

      let temporaryCarFilePath, temporaryBlockstoreDir;
      try {
        // Setup Blockstore
        let temporaryBlockstore = new MemoryBlockstore(),
          temporaryDatastore = new MemoryDatastore();
        if (isNode()) {
          const { mkdir } = await import("node:fs/promises");
          const { FsBlockstore } = await import("blockstore-fs");
          const os = await import("node:os");
          const path = await import("node:path");
          temporaryBlockstoreDir = path.resolve(
            os.tmpdir(),
            "filebase-sdk",
            "uploads",
            uploadUUID,
          );
          temporaryCarFilePath = `${temporaryBlockstoreDir}/main.car`;
          await mkdir(temporaryBlockstoreDir, { recursive: true });
          temporaryBlockstore = new FsBlockstore(temporaryBlockstoreDir);
        }
        let createdFiles = new Map();
        const heliaFs = unixfs({
          blockstore: temporaryBlockstore,
        });
        uploadLogger.verbose("UNIXFS_ADD", {
          count: source.length,
        });
        let createFilePromises = [];
        const queue = new PQueue({ concurrency: 50 });
        for (let entry of source) {
          entry.path = entry.path.startsWith("/") ? entry.path : `/${entry.path}`;
          if (entry.content === null) {
            continue;
          }
          const task = (async () => {
            await queue.add(async () => {
              uploadLogger.silly("SOURCE_IMPORT_STARTED", {
                path: entry.path,
                size: queue.size,
              });

              if (isNode()) {
                const { Readable } = await import("node:stream");
                let createdFile;
                if (
                  (entry.type === "import" &amp;&amp; entry.content !== null) ||
                  entry.content instanceof Readable
                ) {
                  let filehandle;
                  try {
                    if (entry.type === "import") {
                      const { open } = await import("node:fs/promises");
                      const path = await import("node:path");
                      filehandle = await open(path.resolve(entry.content), "r");
                      entry.content = filehandle.createReadStream();
                    }
                    createdFile = await heliaFs.addByteStream(entry.content);
                  } catch (err) {
                    if (typeof filehandle !== "undefined") {
                      await filehandle.close();
                    }
                    throw err;
                  }
                  if (typeof filehandle !== "undefined") {
                    await filehandle.close();
                  }
                } else if (entry.content !== null) {
                  createdFile = await heliaFs.addBytes(entry.content);
                } else {
                  return;
                }
                createdFiles.set(entry.path, createdFile);
                uploadLogger.verbose("SOURCE_IMPORT_COMPLETED", {
                  path: entry.path,
                  size: queue.size,
                });
              } else {
                let createdFile;
                if (entry.type === "import" &amp;&amp; entry.content !== null) {
                  createdFile = await heliaFs.addByteStream(entry.content);
                } else if (entry.content !== null) {
                  createdFile = await heliaFs.addBytes(entry.content);
                } else {
                  return;
                }
                createdFiles.set(entry.path, createdFile);
                uploadLogger.verbose("SOURCE_IMPORT_COMPLETED", {
                  path: entry.path,
                  size: queue.size,
                });
              }
            });
          })();
          if (queue.size > 150) {
            await queue.onSizeLessThan(100);
          }
          createFilePromises.push(task);
          uploadLogger.verbose("SOURCE_IMPORT_QUEUED", {
            path: entry.path,
            size: queue.size,
          });
        }
        await Promise.all(createFilePromises);
        uploadLogger.verbose("UNIXFS_ADDED", {
          count: createdFiles.size,
        });

        const heliaMfs = mfs({
          blockstore: temporaryBlockstore,
          datastore: temporaryDatastore,
        });
        uploadLogger.verbose("MFS_ADDING", {
          count: source.length,
          output: temporaryCarFilePath,
        });
        for (const entry of source) {
          if (entry.content === null) {
            uploadLogger.silly("MFS_DIR_CREATING", {
              path: entry.path,
            });
            await heliaMfs.mkdir(entry.path);
            uploadLogger.verbose("MFS_DIR_CREATED", {
              path: entry.path,
            });
          } else {
            const entryFile = createdFiles.get(entry.path);
            uploadLogger.silly("MFS_FILE_COPY", {
              cid: entryFile,
              path: entry.path,
            });
            await heliaMfs.cp(entryFile, entry.path, {
              force: true,
            });
            uploadLogger.verbose("MFS_FILE_COPIED", {
              cid: entryFile,
              path: entry.path,
            });
          }
        }
        for (const entry of source) {
          parsedEntries[entry.path] = await heliaMfs.stat(entry.path);
          uploadLogger.silly("MFS_PATH_STAT", parsedEntries[entry.path]);
        }
        parsedEntries["/"] = await heliaMfs.stat("/");
        const rootEntry = parsedEntries["/"];
        uploadLogger.verbose("MFS_ADDED", {
          root: rootEntry,
          count: Object.keys(parsedEntries).length,
        });

        // Get carFile stream here
        uploadLogger.verbose("CAR_EXPORTING", {
          root: rootEntry,
        });
        const carExporter = car({ blockstore: temporaryBlockstore }),
          { writer, out } = CarWriter.create([rootEntry.cid]);

        if (isNode()) {
          const { createReadStream, createWriteStream } = await import(
            "node:fs"
          );
          const { Readable } = await import("node:stream");
          // Put carFile stream to disk
          const output = createWriteStream(temporaryCarFilePath);
          Readable.from(out).pipe(output);
          await carExporter.export(rootEntry.cid, writer);
          uploadLogger.verbose("CAR_EXPORTED", {
            root: rootEntry,
          });

          // Set Uploader to Read from carFile on disk
          uploadOptions.params.Body = createReadStream(temporaryCarFilePath);
        }

        // Upload carFile via S3
        uploadLogger.verbose("CAR_UPLOADING", {
          entry: rootEntry,
          source: temporaryCarFilePath,
        });
        const parallelUploads3 = new Upload(uploadOptions);
        parallelUploads3.on("httpUploadProgress", (progress) => {
          uploadLogger.debug("CAR_UPLOAD_PROGRESS", progress);
        });
        await parallelUploads3.done();
        uploadLogger.verbose("CAR_UPLOADED", {
          entry: rootEntry,
          source: temporaryCarFilePath,
        });
        await temporaryBlockstore.close();
      } catch (err) {
        console.error(err.message);
        throw err;
      } finally {
        if (typeof temporaryBlockstoreDir !== "undefined" &amp;&amp; isNode()) {
          const { rm } = await import("node:fs/promises");
          // Delete Temporary Blockstore
          await rm(temporaryBlockstoreDir, { recursive: true, force: true });
        }
      }
    } else {
      // Upload file via S3
      const parallelUploads3 = new Upload(uploadOptions);
      await parallelUploads3.done();
    }

    // Get CID from Platform
    const command = new HeadObjectCommand({
        Bucket: bucket,
        Key: key,
        Body: source,
      }),
      headResult = await this.#client.send(command),
      responseCid = headResult.Metadata.cid;

    if (Object.keys(parsedEntries).length === 0) {
      return {
        cid: responseCid,
        download: () => {
          return this.#routeDownload(responseCid, key, options);
        },
      };
    }
    return {
      cid: responseCid,
      download: () => {
        return this.#routeDownload(responseCid, key, options);
      },
      entries: parsedEntries,
    };
  }

  async #routeDownload(cid, key, options) {
    return typeof this.#gatewayConfiguration.endpoint !== "undefined"
      ? downloadFromGateway(cid, this.#gatewayConfiguration)
      : this.download(key, options);
  }

  /**
   * @summary Gets an objects info and metadata using the S3 API.
   * @param {string} key - The key of the object to be inspected.
   * @param {objectOptions} [options] - The options for inspecting the object.
   * @returns {Promise&lt;objectHeadResult|false>}
   */
  async get(key, options) {
    const bucket = options?.bucket || this.#defaultBucket;
    try {
      const command = new HeadObjectCommand({
          Bucket: bucket,
          Key: key,
        }),
        response = await this.#client.send(command);

      response.download = () => {
        return this.#routeDownload(response.Metadata.cid, key, options);
      };

      return response;
    } catch (err) {
      if (err.name === "NotFound") {
        return false;
      }
      throw err;
    }
  }

  /**
   * @summary Downloads an object from the specified bucket using the provided key.
   * @param {string} key - The key of the object to be downloaded.
   * @param {objectOptions} [options] - The options for downloading the object.
   * @returns {Promise&lt;Object>} - A promise that resolves with the contents of the downloaded object as a Stream.
   * @example
   * // Download object with name of `download-object-example`
   * await objectManager.download(`download-object-example`);
   */
  async download(key, options) {
    // Download via IPFS Gateway if Setup or S3 by Default
    if (typeof this.#gatewayConfiguration.endpoint === "string") {
      const objectToFetch = await this.get(key, options);
      return objectToFetch.download();
    } else {
      const command = new GetObjectCommand({
          Bucket: options?.bucket || this.#defaultBucket,
          Key: key,
        }),
        response = await this.#client.send(command);

      return response.Body;
    }
  }

  /**
   * @typedef {Object} listObjectsResult
   * @property {boolean} IsTruncated Indicates if more results exist on the server
   * @property {string} NextContinuationToken ContinuationToken used to paginate list requests
   * @property {Array&lt;Object>} Contents List of Keys stored in the S3 Bucket
   * @property {string} Contents.Key Key of the Object
   * @property {string} Contents.LastModified Date Last Modified of the Object
   * @property {string} Contents.CID CID of the Object
   * @property {string} Contents.ETag ETag of the Object
   * @property {number} Contents.Size Size in Bytes of the Object
   * @property {string} Contents.StorageClass Class of Storage of the Object
   * @property {function} Contents.download Convenience function to download the item using the S3 gateway
   */

  /**
   * @typedef {Object} listObjectOptions
   * @property {string} [Bucket] The name of the bucket. If not provided, the default bucket will be used.
   * @property {string} [ContinuationToken=null] Continues listing from this objects name.
   * @property {string} [Delimiter=null] Character used to group keys
   * @property {number} [MaxKeys=1000] The maximum number of objects to retrieve. Defaults to 1000.
   */

  /**
   * Retrieves a list of objects from a specified bucket.
   *
   * @param {listObjectOptions} options - The options for listing objects.
   * @returns {Promise&lt;listObjectsResult>} - A promise that resolves to an array of objects.
   * @example
   * // List objects in bucket with a limit of 1000
   * await objectManager.list({
   *   MaxKeys: 1000
   * });
   */
  async list(
    options = {
      Bucket: this.#defaultBucket,
      ContinuationToken: null,
      Delimiter: null,
      MaxKeys: 1000,
    },
  ) {
    if (options?.MaxKeys &amp;&amp; options.MaxKeys > 100000) {
      throw new Error(`MaxKeys Maximum value is 100000`);
    }
    const bucket = options?.Bucket || this.#defaultBucket,
      limit = options?.MaxKeys || 1000,
      commandOptions = {
        Bucket: bucket,
        MaxKeys: limit,
      },
      command = new ListObjectsV2Command({
        ...options,
        ...commandOptions,
      });

    const { Contents, IsTruncated, NextContinuationToken } =
      await this.#client.send(command);
    return { Contents, IsTruncated, NextContinuationToken };
  }

  /**
   * @summary Deletes an object from the specified bucket using the provided key.
   * @param {string} key - The key of the object to be deleted.
   * @param {objectOptions} [options] - The options for deleting the file.
   * @returns {Promise&lt;Boolean>} - A Promise that resolves with the result of the delete operation.
   * @example
   * // Delete object with name of `delete-object-example`
   * await objectManager.delete(`delete-object-example`);
   */
  async delete(key, options) {
    const command = new DeleteObjectCommand({
      Bucket: options?.bucket || this.#defaultBucket,
      Key: key,
    });

    await this.#client.send(command);
    return true;
  }

  /**
   * @typedef {Object} copyObjectOptions
   * @property {string} [sourceBucket] The source bucket from where the object is to be copied.
   * @property {string} [destinationKey] The key of the object in the destination bucket. By default, it is the same as the sourceKey.
   */

  /**
   * If the destinationKey is not provided, the object will be copied with the same key as the sourceKey.
   *
   * @summary Copy the object from sourceKey in the sourceBucket to destinationKey in the destinationBucket.
   * @param {string} sourceKey - The key of the object to be copied from the sourceBucket.
   * @param {string} destinationBucket - The bucket where the object will be copied to.
   * @param {copyObjectOptions} [options] - Additional options for the copy operation.
   *
   * @returns {Promise&lt;Boolean>} - A Promise that resolves with the result of the copy operation.
   * @example
   * // Copy object `copy-object-test` from `copy-object-test-pass-src` to `copy-object-test-pass-dest`
   * // TIP: Set bucket on constructor, it will be used as the default source for copying objects.
   * await objectManager.copy(`copy-object-test`, `copy-object-dest`, {
   *   sourceBucket: `copy-object-src`
   * });
   */
  async copy(
    sourceKey,
    destinationBucket,
    options = {
      sourceBucket: this.#defaultBucket,
      destinationKey: undefined,
    },
  ) {
    const copySource = `${
        options?.sourceBucket || this.#defaultBucket
      }/${sourceKey}`,
      command = new CopyObjectCommand({
        CopySource: copySource,
        Bucket: destinationBucket,
        Key: options?.destinationKey || sourceKey,
      });

    await this.#client.send(command);
    return true;
  }
}

// Function to count slashes in a path
function countSlashes(path) {
  return (path.match(/\//g) || []).length;
}

// Function to check if the code is running in Node.js or the browser
function isNode() {
  return typeof process !== "undefined" &amp;&amp; process.release.name === "node";
}

export default ObjectManager;
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">Filebase SDK</a><div class="mobile-nav-links"><div class="navbar-item"><a id="" href="https://github.com/filebase/filebase-sdk" target="_blank">Github</a></div><div class="navbar-item"><a id="" href="https://www.npmjs.com/package/@filebase/sdk" target="_blank">npm</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="BucketManager.html">BucketManager</a></div><div class="sidebar-section-children"><a href="GatewayManager.html">GatewayManager</a></div><div class="sidebar-section-children"><a href="NameManager.html">NameManager</a></div><div class="sidebar-section-children"><a href="ObjectManager.html">ObjectManager</a></div><div class="sidebar-section-children"><a href="PinManager.html">PinManager</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-tutorials"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-quickstart-bucket.html">Buckets</a></div><div class="sidebar-section-children"><a href="tutorial-quickstart-gateway.html">Gateways</a></div><div class="sidebar-section-children"><a href="tutorial-quickstart-name.html">Names</a></div><div class="sidebar-section-children"><a href="tutorial-quickstart-object.html">Objects</a></div><div class="sidebar-section-children"><a href="tutorial-quickstart-pin.html">Pins</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#bucket">bucket</a></div><div class="sidebar-section-children"><a href="global.html#gateway">gateway</a></div><div class="sidebar-section-children"><a href="global.html#gatewayOptions">gatewayOptions</a></div><div class="sidebar-section-children"><a href="global.html#name">name</a></div><div class="sidebar-section-children"><a href="global.html#nameOptions">nameOptions</a></div><div class="sidebar-section-children"><a href="global.html#objectManagerOptions">objectManagerOptions</a></div><div class="sidebar-section-children"><a href="global.html#objectDownloadOptions">objectDownloadOptions</a></div><div class="sidebar-section-children"><a href="global.html#objectOptions">objectOptions</a></div><div class="sidebar-section-children"><a href="global.html#objectHeadResult">objectHeadResult</a></div><div class="sidebar-section-children"><a href="global.html#listObjectsResult">listObjectsResult</a></div><div class="sidebar-section-children"><a href="global.html#listObjectOptions">listObjectOptions</a></div><div class="sidebar-section-children"><a href="global.html#copyObjectOptions">copyObjectOptions</a></div><div class="sidebar-section-children"><a href="global.html#pinManagerOptions">pinManagerOptions</a></div><div class="sidebar-section-children"><a href="global.html#pinDownloadOptions">pinDownloadOptions</a></div><div class="sidebar-section-children"><a href="global.html#pinStatus">pinStatus</a></div><div class="sidebar-section-children"><a href="global.html#pinOptions">pinOptions</a></div><div class="sidebar-section-children"><a href="global.html#listPinOptions">listPinOptions</a></div><div class="sidebar-section-children"><a href="global.html#listPinResults">listPinResults</a></div><div class="sidebar-section-children"><a href="global.html#replacePinOptions">replacePinOptions</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>